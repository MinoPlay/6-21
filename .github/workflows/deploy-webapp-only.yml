name: Deploy Web App Only

on:
  workflow_dispatch:
    inputs:
      webapp-name:
        description: 'Name of the existing Azure Web App'
        required: true
        type: string

permissions:
  id-token: write
  contents: read

env:
  AZURE_RESOURCE_GROUP: rg-habit-tracker

jobs:
  build:
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Set up Python
      uses: actions/setup-python@v4
      with:
        python-version: '3.10'

    - name: Install dependencies
      run: |
        python -m pip install --upgrade pip
        pip install -r requirements.txt

    - name: Create deployment package
      run: |
        mkdir -p publish
        cp -r app publish/
        cp -r app/static publish/app/
        cp -r app/templates publish/app/
        cp config.py publish/
        cp run.py publish/
        cp requirements.txt publish/

    - name: Upload artifact
      uses: actions/upload-artifact@v4
      with:
        name: habit-tracker-app
        path: ./publish

  deploy:
    runs-on: ubuntu-latest
    needs: build
    
    steps:
    - name: Download application artifact
      uses: actions/download-artifact@v4
      with:
        name: habit-tracker-app
        path: ./publish

    - name: Login to Azure
      uses: azure/login@v2
      with:
        client-id: ${{ secrets.AZURE_CLIENT_ID }}
        tenant-id: ${{ secrets.AZURE_TENANT_ID }}
        subscription-id: ${{ secrets.AZURE_SUBSCRIPTION_ID }}

    - name: Verify Web App exists
      id: verify-webapp
      run: |
        echo "Verifying Web App '${{ inputs.webapp-name }}' exists..."
        
        if ! az webapp show --name ${{ inputs.webapp-name }} --resource-group ${{ env.AZURE_RESOURCE_GROUP }} --output none 2>/dev/null; then
          echo "‚ùå ERROR: Web App '${{ inputs.webapp-name }}' not found in resource group '${{ env.AZURE_RESOURCE_GROUP }}'"
          echo "Please run the full deployment workflow first."
          exit 1
        fi
        
        echo "‚úÖ Web App '${{ inputs.webapp-name }}' found and ready for deployment"

    - name: Get Web App URL
      id: get-webapp-url
      run: |
        WEB_APP_HOSTNAME=$(az webapp show --name ${{ inputs.webapp-name }} --resource-group ${{ env.AZURE_RESOURCE_GROUP }} --query "defaultHostName" --output tsv)
        WEB_APP_URI="https://${WEB_APP_HOSTNAME}"
        
        echo "webAppUri=$WEB_APP_URI" >> $GITHUB_OUTPUT
        echo "Web App URL: $WEB_APP_URI"

    - name: Start Web App
      run: |
        echo "Starting Web App..."
        az webapp start --name ${{ inputs.webapp-name }} --resource-group ${{ env.AZURE_RESOURCE_GROUP }}
        echo "‚úÖ Web App started successfully"

    - name: Deploy to Azure Web App
      uses: azure/webapps-deploy@v3
      with:
        app-name: ${{ inputs.webapp-name }}
        package: ./publish

    - name: Output deployment summary
      run: |
        echo "üöÄ Web App deployment completed successfully!"
        echo "üåê Application URL: ${{ steps.get-webapp-url.outputs.webAppUri }}"
        echo "üìä View in Azure Portal: https://portal.azure.com/#@/resource/subscriptions/${{ secrets.AZURE_SUBSCRIPTION_ID }}/resourceGroups/${{ env.AZURE_RESOURCE_GROUP }}/providers/Microsoft.Web/sites/${{ inputs.webapp-name }}"
        echo ""
        echo "‚ÑπÔ∏è  Note: Only the web application was deployed. Infrastructure remains unchanged."

    - name: Logout from Azure
      if: always()
      run: az logout
